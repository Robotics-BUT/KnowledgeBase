<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>BUT Robotics - knowledge base</title>
        
        <meta name="robots" content="noindex" />
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="intro.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="software/intro.html"><strong aria-hidden="true">2.</strong> Software</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="software/qt/intro.html"><strong aria-hidden="true">2.1.</strong> Qt</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="software/qt/raspberry.html"><strong aria-hidden="true">2.1.1.</strong> Qt on Raspberry Pi</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="hardware/intro.html"><strong aria-hidden="true">3.</strong> Hardware</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="hardware/arduino/intro.html"><strong aria-hidden="true">3.1.</strong> Arduino</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="hardware/arduino/leonardo.html"><strong aria-hidden="true">3.1.1.</strong> Arduino Leonardo</a></li><li class="chapter-item expanded "><a href="hardware/arduino/max7219_matrix.html"><strong aria-hidden="true">3.1.2.</strong> MAX72XX Matrix displays</a></li></ol></li><li class="chapter-item expanded "><a href="hardware/interfacing/intro.html"><strong aria-hidden="true">3.2.</strong> Interfacing</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="hardware/interfacing/ch341a.html"><strong aria-hidden="true">3.2.1.</strong> CH341A dongle</a></li></ol></li><li class="chapter-item expanded "><a href="hardware/tgz48.html"><strong aria-hidden="true">3.3.</strong> TGZ48</a></li><li class="chapter-item expanded "><a href="hardware/uncategorized/intro.html"><strong aria-hidden="true">3.4.</strong> Uncategorized</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="hardware/uncategorized/ikea_tradfri.html"><strong aria-hidden="true">3.4.1.</strong> IKEA Tradfri</a></li><li class="chapter-item expanded "><a href="hardware/uncategorized/msp430_pio.html"><strong aria-hidden="true">3.4.2.</strong> IKEA Tradfri</a></li></ol></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">BUT Robotics - knowledge base</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1><a class="header" href="#knowledge-base" id="knowledge-base">Knowledge Base</a></h1>
<h1><a class="header" href="#software" id="software">Software</a></h1>
<h1><a class="header" href="#qt" id="qt">QT</a></h1>
<h1><a class="header" href="#getting-qt-to-work-on-raspberry-pi" id="getting-qt-to-work-on-raspberry-pi">Getting Qt to work on Raspberry Pi</a></h1>
<h2><a class="header" href="#installing-from-repositories" id="installing-from-repositories">Installing from repositories</a></h2>
<h2><a class="header" href="#building-from-source" id="building-from-source">Building from source</a></h2>
<p>This tutorial was inspired by the tutorial <a href="https://www.tal.org/tutorials/building-qt-512-raspberry-pi">here</a>.
We will be using Qt 5.15 and skipping useless modules. Also gamepad and multimedia with GStreamer should be working out of the box.</p>
<p>Install preprequisities by running</p>
<pre><code class="language-bash">sudo apt-get update
sudo apt-get install git gdb cmake gcc build-essential libfontconfig1-dev libdbus-1-dev libfreetype6-dev libicu-dev libinput-dev libxkbcommon-dev libsqlite3-dev libssl-dev libpng-dev libjpeg-dev libglib2.0-dev libraspberrypi-dev
sudo apt-get install libgstreamer1.0-dev libgstreamer-plugins-base1.0-dev gstreamer1.0-plugins-base gstreamer1.0-plugins-good gstreamer1.0-plugins-ugly gstreamer1.0-plugins-bad libgstreamer-plugins-bad1.0-dev gstreamer1.0-pulseaudio gstreamer1.0-tools gstreamer1.0-alsa libasound2-dev pulseaudio libpulse-dev libsdl2-dev libgles2-mesa-dev libgbm-dev libgl1-mesa-dev libglu1-mesa-dev mesa-common-dev libx11-dev
</code></pre>
<p>Download the sources from <a href="http://download.qt.io/official_releases/qt/">here</a> in our case we'll be using <code>wget</code> and downloading the 5.15.1 version</p>
<pre><code class="language-bash">wget http://download.qt.io/official_releases/qt/5.15/5.15.1/single/qt-everywhere-src-5.15.1.tar.xz
</code></pre>
<p>Decompress the archive by running</p>
<pre><code class="language-bash">tar xf qt-everywhere-src-5.15.1.tar.xz
</code></pre>
<p>Setup build configurations for the Raspberry Pi</p>
<pre><code class="language-bash">git clone https://github.com/oniongarlic/qt-raspberrypi-configuration.git
cd qt-raspberrypi-configuration &amp;&amp; make install DESTDIR=../qt-everywhere-src-5.15.1
cd ..
</code></pre>
<p>Prepare the build environment</p>
<pre><code class="language-bash">mkdir -p build
cd build
PKG_CONFIG_LIBDIR=/usr/lib/arm-linux-gnueabihf/pkgconfig:/usr/share/pkgconfig ../qt-everywhere-src-5.15.1/configure -platform linux-rpi4-v3d-g++ -v -opengl es2 -eglfs -no-gtk -no-xcb -opensource -confirm-license -release -reduce-exports -force-pkg-config -nomake examples -no-compile-examples -skip qtwayland -skip qtwebengine -skip qt3d -skip qtlocation -skip qtscript -skip qtsensors -skip qtserialport -skip qtspeech -skip qtcharts -skip qtvirtualkeyboard -skip qtquick3d  -qt-pcre -no-pch -ssl -evdev -system-freetype -fontconfig -glib -prefix /opt/Qt5.15 -qpa eglfs
</code></pre>
<p>And build it!</p>
<pre><code class="language-bash">make -j4
sudo make install
</code></pre>
<h3><a class="header" href="#notes" id="notes">Notes</a></h3>
<p>It is recommended to use swap - at least 1 GB. 
It is also recommended to use <code>tmux</code> for running the build for cases of SSH disconnections.
You should also cool the Raspberry Pi properly, a small fan is enough to lower the CPU temperature by 20 C!.</p>
<h1><a class="header" href="#hardware" id="hardware">Hardware</a></h1>
<p>This chapter contains information about making devices work and general tips for working with them.</p>
<h1><a class="header" href="#arduino" id="arduino">Arduino</a></h1>
<p>This section contains bits of information about the Arduino boards itself, its main purpose however is providing information about using 3rd party modules with Arduino boards - mainly describing used libraries, but also electrical connections.</p>
<h1><a class="header" href="#arduino-leonardo" id="arduino-leonardo">Arduino Leonardo</a></h1>
<h2><a class="header" href="#spi-problems" id="spi-problems">SPI problems</a></h2>
<p>Arduino Leonardo doesn't have SPI connected to the female headers on its sides, SPI is only connected to the ICSP 6-pin header on the back of the board. The pinout can be seen in the following image.</p>
<blockquote>
<p>Note that there are multiple pinout images around the internet that show the SPI pins connected to the side female headers.</p>
</blockquote>
<p><img src="https://duino4projects.com/wp-content/uploads/2013/04/Ardunio_leonardo_pinout.jpg" alt="Leonardo" /></p>
<ol>
<li><a href="https://duino4projects.com/arduino-leonardo-pinout-diagram/">https://duino4projects.com/arduino-leonardo-pinout-diagram/</a></li>
</ol>
<h1><a class="header" href="#maxim-7219-single-color-matrix-displays" id="maxim-7219-single-color-matrix-displays">Maxim 7219 single color matrix displays</a></h1>
<p><img src="https://camo.githubusercontent.com/7a575fd18e96ae0e9d0355fa2989100406b5d23d/687474703a2f2f692e696d6775722e636f6d2f426656507938682e6a7067" alt="Display" /> [1]</p>
<p>There are several modules with this chip and the matrix itself for example the FC-16, which either comes with a single 8x8 matrix or 4 of these combined together forming a 64x8 matrix display.</p>
<p>A library that can be used to jumpstart the development is the <a href="https://github.com/MajicDesigns/MD_MAX72xx">MD_MAX72XX</a> library and for animations and scrolling the <a href="https://github.com/MajicDesigns/MD_Parola">MD_Parola</a> library can be easily used.</p>
<p>[1] <a href="https://github.com/ridercz/Altairis-ESP8266-FC16">https://github.com/ridercz/Altairis-ESP8266-FC16</a></p>
<h1><a class="header" href="#hardware-interfacing" id="hardware-interfacing">Hardware interfacing</a></h1>
<p>This section describes hardware commonly used to interface other hardware - such as CAN dongles and modules, USB dongles, etc.</p>
<h1><a class="header" href="#ch341a-universal-interface-dongle" id="ch341a-universal-interface-dongle">CH341A universal interface dongle</a></h1>
<p><img src="https://zoobab.wdfiles.com/local--files/ch341-usb-spi-i2c-uart-isp-dongle/ch341a-devboard2.jpg" alt="dongle" /> [1]</p>
<p>The CH341A provides USB accessible UART, I2C and SPI peripherals and some GPIO. The UART could theoretically be hooked to an RS232 transciever with hardware flow control etc.
The problem is that the software support for this chip isn't that good even in Linux kernel. USB -&gt; UART works out of the box, but I2C and SPI need their respective non upstream kernel modules loaded by the user.</p>
<blockquote>
<p>From the design of these kernel modules it might not be possible to use both SPI and I2C simultaneously. This hasn't been confirmed as there was not enough experience in Linux kernel module development.</p>
</blockquote>
<p>Working modules for the board are for example these:</p>
<ul>
<li><a href="https://github.com/gschorcht/i2c-ch341-usb">I2C + GPIO</a></li>
<li><a href="https://github.com/gschorcht/spi-ch341-usb">SPI + GPIO</a></li>
</ul>
<p>These modules however need some small changes in the <code>Makefile</code> (at least for building on Arch/Manjaro changing line 7 to <code> KERNEL_DIR  = /usr/lib/modules/$(KVERSION)/build</code> was required, DKMS failed on this operating system meaning that the modules need to be rebuilt when kernel updates).</p>
<blockquote>
<p>It might be an interesting task to at first combine the module for I2C and SPI into one and also to write the kernel module in Rust for better maintainibility.</p>
</blockquote>
<p>[1] <a href="https://zoobab.wdfiles.com/local--files/ch341-usb-spi-i2c-uart-isp-dongle/ch341a-devboard2.jpg">https://zoobab.wdfiles.com/local--files/ch341-usb-spi-i2c-uart-isp-dongle/ch341a-devboard2.jpg</a></p>
<h1><a class="header" href="#tgz48" id="tgz48">TGZ48</a></h1>
<h2><a class="header" href="#calculating-position-from-revolutions-and-angle" id="calculating-position-from-revolutions-and-angle">Calculating position from revolutions and angle</a></h2>
<pre><code class="language-c++">auto map = packet.asMap();
const uint32_t drive1Angle = static_cast&lt;int32_t&gt;(map[TGZRegisters::Monitor1_aAngle]);
const int32_t drive1Revs = static_cast&lt;int32_t&gt;(map[TGZRegisters::Monitor1_aRevol]);

const float revolutions = drive1Angle / static_cast&lt;float&gt;(static_cast&lt;uint32_t&gt;(0xffffffff)) + static_cast&lt;float&gt;(drive1Revs);
</code></pre>
<p>The key here is to correctly use signed and unsigned integers, mainly for storing the <code>drive1Angle</code> and when casting the maximum value to float.</p>
<h1><a class="header" href="#uncategorized-hardware" id="uncategorized-hardware">Uncategorized hardware</a></h1>
<p>This section contains descriptions of hardware that may not be directly connected to robotics. I makes sense, however, to make some notes about making it work.</p>
<h1><a class="header" href="#ikea-tradfri" id="ikea-tradfri">IKEA Tradfri</a></h1>
<h2><a class="header" href="#ikea-tradfri--phillips-hue--homekit" id="ikea-tradfri--phillips-hue--homekit">IKEA Tradfri + Phillips Hue + HomeKit</a></h2>
<p>Both the Tradfri and Hue use ZigBee protocol to operate and also implement some standardized data interface. That means that a Hue bridge can be used to control Tradfri lightbulbs and read data from other sensors.</p>
<p>To connect a lightbulb to the bridge, first in the app it is required to start search for lights. Then the lightbulb needs to be turned off and on 6 times leaving it in connection mode (the bulb changes its brightness in three steps).</p>
<p>The bridge should then identify the bulb and pair with it.</p>
<blockquote>
<p>When the connection mode is activated a new search for lightbulbs in the app can be performed.</p>
</blockquote>
<p>After the pairing finishes, the lightbulb can be easily used with the Hue app, unfortunately the app <strong>won't publish</strong> the 3rd party accessories to HomeKit.</p>
<p>There are two solutions to this problem - either buy the IKEA Tradfri bridge and use it to publish the accessories to the HomeKit, or use a home server running Homebridge with appropriate plugins.</p>
<p>The Homebridge server can be installed using the tutorial <a href="https://github.com/homebridge/homebridge/wiki">here</a> and can then be used to control devices from many more manufacturers that do not implement HomeKit on their own.</p>
<p>To make the devices connected to the Hue bridge work, a plugin <a href="https://github.com/ebaauw/homebridge-hue">homebridge-hue</a> needs to be installed and configured with the following configuration, that ensures that the plugin won't advertise native Hue devices, but only the third party one.</p>
<pre><code class="language-json">...
&quot;platforms&quot;: [
        ...
        {
            &quot;name&quot;: &quot;Hue-tradfri&quot;,
            &quot;anyOn&quot;: true,
            &quot;lights&quot;: true,
            &quot;nativeHomeKitLights&quot;: true,
            &quot;nativeHomeKitSensors&quot;: true,
            &quot;nupnp&quot;: true,
            &quot;resource&quot;: true,
            &quot;users&quot;: {
                &quot;USER_ID&quot;: &quot;TOKEN&quot;
            },
            &quot;platform&quot;: &quot;Hue&quot;
        }
        ...
    ]
...
</code></pre>
<blockquote>
<p>Bear in mind, that after installing the plugin and making it connect to the bridge it is required to save the <code>USER_ID</code> and <code>TOKEN</code> to the configuration file.</p>
</blockquote>
<h1><a class="header" href="#using-msp430-with-platformio" id="using-msp430-with-platformio">Using MSP430 with PlatformIO</a></h1>
<p>There are some hurdles when configuring PlatformIO for development with MSP430 as there are no real examples and incomplete docs concerning uploading the code.
The following config seemed to work.</p>
<pre><code class="language-ini">[env:lpmsp430g2553]
platform = timsp430
board = lpmsp430g2553
framework = arduino
debug_tool = mspdebug
upload_protocol = rf2500
</code></pre>
<p>The important parts are <code>debug_tool</code> and <code>upload_protocol</code>.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        

                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                

                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        
        
        <script type="text/javascript">
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>
        
        

    </body>
</html>
